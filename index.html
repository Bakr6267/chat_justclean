<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JustClean Scripts - مدمج مع السكريبتات الافتراضية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        .input-field {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s ease;
            width: 100%;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .script-text {
            cursor: pointer;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
            line-height: 1.6;
        }
        
        .script-text:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: scale(1.01);
        }
        
        .table-header {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: white;
        }
        
        .table-row {
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .table-row:nth-child(even) {
            background: rgba(248, 250, 252, 0.8);
        }
        
        .table-row:hover {
            background: rgba(59, 130, 246, 0.05);
        }
        
        .status-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .close-btn {
            color: #9ca3af;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .close-btn:hover {
            color: #374151;
        }
        
        .category-badge {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            font-size: 12px;
            color: #3b82f6;
            margin-left: 8px;
        }
        
        .help-text {
            background: rgba(59, 130, 246, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 12px;
            color: #1e40af;
            font-size: 14px;
            margin: 16px 0;
        }
        
        .draggable-row {
            cursor: move;
            transition: all 0.2s ease;
        }
        
        .dragging {
            opacity: 0.6;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .drag-over {
            border-top: 3px solid #3b82f6;
        }
        
        .drag-handle {
            cursor: move;
            color: #6b7280;
            font-size: 16px;
            padding: 4px;
            margin-left: 8px;
        }
        
        .drag-handle:hover {
            color: #3b82f6;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- Status Indicator -->
    <div class="status-indicator" id="statusIndicator">محفوظ تلقائياً</div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Add Script Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 class="text-xl font-bold mb-4 text-gray-800">إضافة سكريبت جديد</h2>
            <form id="addForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">نوع المشكلة</label>
                    <select id="newCategory" class="input-field" required>
                        <option value="greeting">ترحيب</option>
                        <option value="delay">تأخير</option>
                        <option value="cancel">إلغاء</option>
                        <option value="complaint">شكوى</option>
                        <option value="payment">دفع</option>
                        <option value="order">طلب</option>
                        <option value="other">أخرى</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">وصف الموقف</label>
                    <input type="text" id="newSituation" class="input-field" required placeholder="مثال: تأخر العامل">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">الرد بالعربي</label>
                    <textarea id="newArabic" class="input-field" rows="3" required placeholder="اكتب الرد هنا..."></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">الرد بالإنجليزي</label>
                    <textarea id="newEnglish" class="input-field" rows="3" required placeholder="Write response here..."></textarea>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="btn-primary flex-1">إضافة</button>
                    <button type="button" id="cancelBtn" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-lg">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Header -->
    <div class="text-white py-6 mb-6">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div>
                    <h1 class="text-3xl font-bold mb-2">سكريبتات JustClean</h1>
                    <p class="text-lg opacity-90">اضغط على أي نص لنسخه فوراً</p>
                </div>
                <div class="flex gap-3">
                    <button id="addBtn" class="btn-success">+ إضافة سكريبت</button>
                    <button id="exportBtn" class="btn-primary">تصدير</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                    <button id="importBtn" class="btn-primary">استيراد</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 pb-8">
        <!-- Search Section -->
        <div class="card p-6 mb-6">
            <div class="mb-4">
                <input type="text" id="searchInput" placeholder="ابحث في السكريبتات..." class="input-field text-lg">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <select id="categoryFilter" class="input-field">
                    <option value="all">كل الأنواع</option>
                    <option value="greeting">ترحيب</option>
                    <option value="delay">تأخير</option>
                    <option value="cancel">إلغاء</option>
                    <option value="complaint">شكوى</option>
                    <option value="payment">دفع</option>
                    <option value="order">طلب</option>
                    <option value="other">أخرى</option>
                </select>
                
                <button id="resetBtn" class="bg-gray-500 text-white px-4 py-3 rounded-lg hover:bg-gray-600">مسح البحث</button>
                
                <div class="flex items-center justify-center bg-green-50 border border-green-200 rounded-lg px-4">
                    <span class="text-green-700 font-medium">العدد: <span id="countDisplay">0</span></span>
                </div>
                
                <button id="clearAllBtn" class="btn-danger">مسح الكل</button>
            </div>
            
            <div class="help-text">
                💡 اضغط على أي نص لنسخه • اسحب من ≡ لإعادة الترتيب • جميع التغييرات تُحفظ تلقائياً • استخدم "تصدير" للنسخ الاحتياطي
            </div>
        </div>
        
        <!-- Scripts Table -->
        <div class="card overflow-hidden">
            <table class="min-w-full">
                <thead class="table-header">
                    <tr>
                        <th class="px-4 py-3 text-right font-medium">ترتيب</th>
                        <th class="px-4 py-3 text-right font-medium">النوع</th>
                        <th class="px-4 py-3 text-right font-medium">الموقف</th>
                        <th class="px-4 py-3 text-right font-medium">الرد العربي</th>
                        <th class="px-4 py-3 text-right font-medium">الرد الإنجليزي</th>
                        <th class="px-4 py-3 text-right font-medium">حذف</th>
                    </tr>
                </thead>
                <tbody id="scriptsTable">
                    <!-- Scripts will be inserted here -->
                </tbody>
            </table>
        </div>
    </main>

    <script>
        // === CONFIGURATION ===
        // Default scripts embedded in the code (from the JSON you provided)
        const defaultScripts = [
  {
    "id": 24,
    "category": "greetings",
    "situation": "تحية و انتظار ",
    "arabic": "مرحبا معك ابوبكر من خدمة عملاء تطبيق جست كلين. اسمح لي بمراجعه تفاصيل الطلب.. رجاءا ابقى معانا بضع دقائق علي الانتظار",
    "english": "Hello, this is abobakr from JustClean customer care. Please bear with me for a few minutes to review your order details."
  },
  {
    "id": 0,
    "category": "greetings",
    "situation": "التحية الأولية",
    "arabic": "مرحبا معك ابوبكر من خدمة عملاء تطبيق جست كلين.. كيف يمكنني مساعدتك؟",
    "english": "Hello, this is abobakr from JustClean customer care. How may I assist you?"
  },
  {
    "id": 16,
    "category": "waiting",
    "situation": "اطلب من العميل الانتظار",
    "arabic": "اسمح لي بمراجعه تفاصيل الطلب.. رجاءا ابقى معانا بضع دقائق علي الانتظار",
    "english": "Please bear with me for a few minutes to review your order details."
  },
  {
    "id": 22,
    "category": "waiting",
    "situation": "انهاء الانتظار ",
    "arabic": "شكرا لأنتظارك، نحن نقدر حقا صبرك ونعتذر لك عن اى تأخير ",
    "english": "Thank you for holding. I really appreciate your patience"
  },
  {
    "id": 23,
    "category": "feedback",
    "situation": "القسم المختص",
    "arabic": "سوف أرسل للقسم المختص وسيتم التواصل معك هاتفياً فور وصول الرد.",
    "english": "I will send it to the relevant department and they will contact you by phone as soon as the response arrives."
  },
  {
    "id": 26,
    "category": "order",
    "situation": "طلب للقسم",
    "arabic": "لقد ارسلت طلبك للقسم المختص وسيتم التواصل معك هاتفياً فور وصول الرد.",
    "english": "Your request has been sent to the relevant department, and you will be contacted by phone as soon as the response\u00a0arrives."
  },
  {
    "id": 20,
    "category": "closing",
    "situation": "عدم استجابة العميل",
    "arabic": "عذرا لم نتلق منك أي رد منذ فترة، سنقوم الآن بالخروج من المحادثة ونرجو عدم التردد في محادثتنا مرة أخرى إن أردت مساعدتنا، شكرا لاتصالك بجست كلين",
    "english": "Sorry, we didn't hear from you in a while. This chat will be closed, but please feel free to contact us again if you need any assistance. Thank you for contacting JustClean."
  },
  {
    "id": 21,
    "category": "closing",
    "situation": "انهاء المحادثة ",
    "arabic": "هل يوجد شيء اخر استطيع مساعدتك به اليوم؟",
    "english": "is there anything else I might help you with today?"
  },
  {
    "id": 19,
    "category": "feedback",
    "situation": "إنهاء المحادثة",
    "arabic": "شكرا لاتصالك على جست كلين. إذا طرأت لديك اي اسئله اخرى فلا تتردد في الاتصال بنا عبر خدمة المحادثة المباشرة أو عن طريق الايميل customercare@Justclean.com",
    "english": "Thank you for contacting JustClean. For any further questions, please contact us via Live Chat or email customercare@Justclean.com"
  },
  {
    "id": 25,
    "category": "delays",
    "situation": "reschedule out of the policy",
    "arabic": "الفكرة ان مزود الخدمه الذي قمت بحجزه يقوم بتخصيص موظفين مخصوصا لطلبك و يكون الموعد الذي قمت بحجزه غير متاح للاستخدام من قبل اي عميل اخر ، و لذلك\nو طبقا للشروط و الاحكام الخاصه بالخدمه فان الغاء او اعاده جدولة الموعد غير متاح",
    "english": "The service provider you've chosen is assigning his workers to your order, and also the time you've chosen is allocated to you so no other customer can reserve it. Hence, according to the terms and conditions of the service, cancelling or rescheduling is not possible, unfortunately."
  },
  {
    "id": 18,
    "category": "waiting",
    "situation": "متابعة انتظار العميل",
    "arabic": "أسف على التأخير، مازلت اراجع بعض البيانات الخاصة بك، اسمح لى بالانتظار لمزيد من الوقت",
    "english": "I'm sorry for this delay. I'm still checking your details, please give me another moment."
  },
  {
    "id": 17,
    "category": "waiting",
    "situation": "إعلام العميل بالانتظار",
    "arabic": "إذا كنت لا تمانع في وضعك في الانتظار ، فسأكون معك خلال لحظات",
    "english": "If you don't mind me putting you on hold, I'll be with you in a few moments."
  },
  {
    "id": 1,
    "category": "delays",
    "situation": "تأخير خدمة الهوم كليننج",
    "arabic": "بنعتذر منك اخى الكريم نظراً لتأخير العاملة وسوف ارسل الحين للقسم المختص للتاكيد مع مزود الخدمه لسرعه وصول العاملة لك",
    "english": "We apologize for the cleaner's delay and right now I will send to our department to check with the service provider to make the cleaner contact you as soon as possible"
  },
  {
    "id": 2,
    "category": "delays",
    "situation": "تأخير خدمة الكار واش",
    "arabic": "بنعتذر منك اخى الكريم وسوف ارسل الحين للقسم المختص للتاكيد مع مزود الخدمه لسرعه وصول فريق الغسيل لك",
    "english": "We apologize for the delay and right now I will send to our department to check with the service provider to make the washing team contact you as soon as possible"
  },
  {
    "id": 3,
    "category": "delays",
    "situation": "تأخير اللاندرى",
    "arabic": "بنعتذر منك اخى الكريم و الحين سوف اراسل للقسم المختص للتواصل مع المغسله لسرعه وصول الاغراض لك و تواصل السائق معك",
    "english": "We are so sorry for that and right now I will send to our concerned department to check with laundry to make driver contact you as soon as possible to deliver your items"
  },
  {
    "id": 27,
    "category": "greeting",
    "situation": "اخرى",
    "arabic": "عميلنا العزيز, بالفعل يمكنكم كتابة ملاحظة اثناء الطلب بالمواصفات التى تريدينها وايضا اذا كان لديك عاملة مفضلة يمكنك كتابة اسمها حتى يتم إتخاذ هذا الامر فى الحسبان.",
    "english": "Dear customer, you can indeed add a note during the order with the specifications you want, and if you have a preferred worker, you can write her name so that this matter is taken into account."
  },
  {
    "id": 4,
    "category": "cancellations",
    "situation": "إلغاء طلب الهوم كليننج",
    "arabic": "أسف لسماع ذلك، هل من الممكن ان اعرف سبب الالغاء؟",
    "english": "May I know the reason please?"
  },
  {
    "id": 5,
    "category": "cancellations",
    "situation": "إلغاء طلب الكار واش",
    "arabic": "سوف نقوم الأن بألغاء طلبك ونأمل فى خدمتك مرة أخرى فى أقرب وقت",
    "english": "We will now cancel your order and we hope to serve you again soon"
  },
  {
    "id": 6,
    "category": "cancellations",
    "situation": "إلغاء بسبب عدم قبول الطلب",
    "arabic": "بنعتذر منك اخى الكريم نظراً لان لم يتم قبول الطلب من اى مزود خدمه فتم الغاء الطلب تلقائى وارجاع المبلغ لنفس المكان الذى سحب منه تلقائى",
    "english": "We apologize because no service provider accepted the order so it was automatically cancelled and the amount was refunded to the same source"
  },
  {
    "id": 7,
    "category": "complaints",
    "situation": "شكوى على خدمة",
    "arabic": "نحن نأسف حقاً للأمر، سأقوم بإرسال شكواك للقسم المختص لمعالجة الموضوع بأقصى سرعة",
    "english": "We sincerely apologize for this, I will forward your complaint to the concerned department to handle it as soon as possible"
  },
  {
    "id": 8,
    "category": "complaints",
    "situation": "شكوى على سائق",
    "arabic": "نعتذر بشدة عن تصرف السائق وسنتخذ الإجراءات اللازمة لضمان عدم تكرار ذلك",
    "english": "We sincerely apologize for the driver's behavior and we will take necessary actions to ensure this doesn't happen again"
  },
  {
    "id": 9,
    "category": "orders",
    "situation": "تأكيد الطلب",
    "arabic": "سوف اتأكد من القسم المختص لتأكيد طلبك ونعود اليك في أقرب وقت",
    "english": "I will check with the concerned department to confirm your order and get back to you asap"
  },
  {
    "id": 10,
    "category": "orders",
    "situation": "متابعة الطلب",
    "arabic": "طلبك قيد المتابعة حالياً مع القسم المختص وسيتم إعلامك بأي مستجدات",
    "english": "Your order is currently being followed up with the concerned department and we will update you with any developments"
  },
  {
    "id": 11,
    "category": "payments",
    "situation": "إستعلام عن الريفند",
    "arabic": "اخي بالفعل تم الريفند من جانبنا وهذه العملية قد تستغرق بعض الوقت حسب البنك المستخدم",
    "english": "The refund has been processed from our side and it may take some time depending on your bank"
  },
  {
    "id": 12,
    "category": "payments",
    "situation": "مشكلة في الدفع",
    "arabic": "نعتذر عن المشكلة التي واجهتك في الدفع، هل يمكنك مشاركة التفاصيل معنا لمساعدتك؟",
    "english": "We apologize for the payment issue you encountered, could you please share details so we can assist?"
  },
  {
    "id": 13,
    "category": "items",
    "situation": "اغراض ناقصة",
    "arabic": "بنعتذر اخى الكريم والحين سوف ارسل للقسم المختص للتاكيد مع المغسله عن الامر وبمجرد تلقى الرد منهم قسم متابعه الطلبات سوف يتواصل معك",
    "english": "We apologize and will check with the laundry regarding missing items, the follow-up department will contact you once we get a response"
  },
  {
    "id": 14,
    "category": "items",
    "situation": "تسجيل أغراض خطأ",
    "arabic": "نأسف أذا المصبغة قامت بأدخال عدد قطع غير صحيح فى طلبك، سوف نخبر القسم المختص بمراجعة الطلب مرة اخرى مع المصبغه وتعديل الطلب فى أقرب وقت",
    "english": "We apologize if the laundry entered wrong item count, we'll ask the concerned department to review and correct the order"
  },
  {
    "id": 15,
    "category": "feedback",
    "situation": "ملاحظات على التطبيق",
    "arabic": "نحن شاكرين جدا لتعليقك وسوف يأخذ بالأعتبار أرساله الى القسم المختص لتطوير الخدمة لدينا. أستمر بتزويدنا بتعليقاتك حتى نتمكن من تحسين خدماتنا لك",
    "english": "We highly appreciate your feedback which will be forwarded to improve our service. Keep providing feedback so we can serve you better"
  },
  {
    "id": 29,
    "category": "other",
    "situation": "rate the service ",
    "arabic": "يمكنك تقييم الطلب فقط بعد أن يتم توصيله ودفعه، مما يعني أن حالة الطلب هي 'مكتمل' أو 'منتهي'. بعد ذلك، يمكنك الوصول إلى طلبك الأخير وستجد تقييم لكل شيء يتعلق بالخدمة، مثل التوصيل والسائق وجودة الخدمة.",
    "english": "You can evaluate the order only after it has been delivered and paid for, meaning the order status is 'complete' or 'finished'. After that, you can access your last order and you will find an evaluation for everything related to the service, such as delivery, the driver, and service quality."
  }
];

        // Helper: set of default IDs (so we can prevent deleting global defaults)
        const defaultIds = new Set(defaultScripts.map(s => s.id));

        // LocalStorage keys
        const USER_KEY = 'justclean_user_scripts_v1';

        // Load user scripts (only user-added ones)
        function loadUserScripts() {
            try {
                const saved = localStorage.getItem(USER_KEY);
                return saved ? JSON.parse(saved) : [];
            } catch (e) {
                return [];
            }
        }

        // Save user scripts (only user-added)
        function saveUserScripts(userScripts) {
            try {
                localStorage.setItem(USER_KEY, JSON.stringify(userScripts));
                updateStatus('تم الحفظ');
            } catch (e) {
                showNotification('خطأ في الحفظ', 'error');
            }
        }

        // Initialize combined scripts (defaults + user-specific)
        let userScripts = loadUserScripts();
        let scripts = [...defaultScripts, ...userScripts];
        let filteredScripts = [...scripts];
        let nextId = Math.max(...scripts.map(s => s.id || 0), 0) + 1;

        // Update status
        function updateStatus(text) {
            const status = document.getElementById('statusIndicator');
            status.textContent = text;
            setTimeout(() => {
                status.textContent = 'محفوظ تلقائياً';
            }, 2000);
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'error' ? '#ef4444' : '#10b981';
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Copy text
        function copyText(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('تم النسخ');
                });
            } else {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('تم النسخ');
            }
        }

        // Get category display name
        function getCategoryName(category) {
            const names = {
                greeting: 'ترحيب',
                greetings: 'ترحيب',
                delay: 'تأخير',
                delays: 'تأخير',
                cancel: 'إلغاء',
                cancellations: 'إلغاء',
                complaint: 'شكوى',
                complaints: 'شكوى',
                payment: 'دفع',
                payments: 'دفع',
                order: 'طلب',
                orders: 'طلب',
                other: 'أخرى',
                items: 'أغراض',
                feedback: 'ملاحظات',
                closing: 'إنهاء'
            };
            return names[category] || category;
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('scriptsTable');
            tbody.innerHTML = '';
            
            if (filteredScripts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">📝</div>
                            <div>لا توجد سكريبتات</div>
                            <div class="text-sm mt-1">اضغط "إضافة سكريبت" لبدء إضافة السكريبتات</div>
                        </td>
                    </tr>
                `;
            } else {
                filteredScripts.forEach((script, index) => {
                    const row = document.createElement('tr');
                    row.className = 'table-row draggable-row';
                    row.draggable = true;
                    row.dataset.index = index;
                    
                    // Disable delete button for default scripts
                    const isDefault = defaultIds.has(script.id);
                    
                    row.innerHTML = `
                        <td class="px-4 py-3">
                            <div class="drag-handle">≡</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="category-badge">${getCategoryName(script.category)}</span>
                        </td>
                        <td class="px-4 py-3 font-medium">${script.situation}</td>
                        <td class="px-4 py-3">
                            <div class="script-text" onclick="copyText('${script.arabic.replace(/'/g, "\\'")}')">
                                ${script.arabic}
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="script-text" onclick="copyText('${script.english.replace(/'/g, "\\'")}')">
                                ${script.english}
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <button ${isDefault ? 'disabled title="سكريبت افتراضي لا يمكن حذفه" class="btn-danger opacity-50 cursor-not-allowed text-xs px-2 py-1"' : 'onclick="deleteScript('+script.id+')" class="btn-danger text-xs px-2 py-1"'}>
                                حذف
                            </button>
                        </td>
                    `;
                    
                    // إضافة أحداث السحب والإفلات
                    row.addEventListener('dragstart', handleDragStart);
                    row.addEventListener('dragover', handleDragOver);
                    row.addEventListener('drop', handleDrop);
                    row.addEventListener('dragend', handleDragEnd);
                    row.addEventListener('dragenter', handleDragEnter);
                    row.addEventListener('dragleave', handleDragLeave);
                    
                    tbody.appendChild(row);
                });
            }
            
            document.getElementById('countDisplay').textContent = filteredScripts.length;
        }

        // Filter scripts
        function filterScripts() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            
            filteredScripts = scripts.filter(script => {
                const matchesSearch = !search || 
                    (script.situation && script.situation.toLowerCase().includes(search)) ||
                    (script.arabic && script.arabic.toLowerCase().includes(search)) ||
                    (script.english && script.english.toLowerCase().includes(search));
                
                const matchesCategory = category === 'all' || script.category === category;
                
                return matchesSearch && matchesCategory;
            });
            
            renderTable();
        }

        // Delete script (only user-added scripts can be deleted)
        function deleteScript(id) {
            if (defaultIds.has(id)) {
                showNotification('لا يمكن حذف السكريبت الافتراضي', 'error');
                return;
            }
            if (confirm('هل تريد حذف هذا السكريبت؟')) {
                // remove from userScripts
                userScripts = userScripts.filter(s => s.id !== id);
                // rebuild combined
                scripts = [...defaultScripts, ...userScripts];
                saveUserScripts(userScripts);
                filterScripts();
                showNotification('تم الحذف');
            }
        }

        // Add script (adds to userScripts only)
        function addScript(data) {
            const newScript = {
                id: nextId++,
                category: data.category,
                situation: data.situation,
                arabic: data.arabic,
                english: data.english
            };
            userScripts.push(newScript);
            scripts = [...defaultScripts, ...userScripts];
            saveUserScripts(userScripts);
            filterScripts();
            showNotification('تم إضافة السكريبت');
        }

        // Export data (exports only user scripts by default, but includes metadata)
        function exportData() {
            const data = {
                defaultScriptsExported: defaultScripts.length,
                userScripts: userScripts,
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `justclean-user-scripts-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('تم التصدير');
        }

        // Import data (replaces user scripts only)
        function importData(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    // accept both {scripts: [...]} and {userScripts: [...]} and legacy full export
                    const incoming = data.scripts || data.userScripts || (Array.isArray(data) ? data : null);
                    if (incoming && Array.isArray(incoming)) {
                        if (confirm('هل تريد استبدال كل السكريبتات التي أضفتها أنت محليًا؟ (لن تمسح السكريبتات الافتراضية)')) {
                            // ensure ids don't collide with defaults
                            const maxDefaultId = Math.max(...defaultScripts.map(s => s.id || 0), 0);
                            let maxUserId = Math.max(0, ...incoming.map(s => s.id || 0));
                            if (maxUserId <= maxDefaultId) {
                                // reassign ids to avoid collisions
                                incoming.forEach((s, i) => s.id = maxDefaultId + 1 + i);
                            }
                            userScripts = incoming;
                            scripts = [...defaultScripts, ...userScripts];
                            nextId = Math.max(...scripts.map(s => s.id || 0), 0) + 1;
                            saveUserScripts(userScripts);
                            filterScripts();
                            showNotification('تم الاستيراد');
                        }
                    } else {
                        showNotification('ملف غير صحيح', 'error');
                    }
                } catch (err) {
                    showNotification('خطأ في قراءة الملف', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Clear all user-added scripts (does not remove defaults)
        function clearAll() {
            if (confirm('هل تريد مسح كل السكريبتات التي أضفتها محليًا؟\nالسكريبتات الافتراضية ستبقى كما هي.')) {
                userScripts = [];
                scripts = [...defaultScripts];
                saveUserScripts(userScripts);
                filterScripts();
                showNotification('تم مسح كل السكريبتات المحليّة');
            }
        }

        // Modal functions
        function openModal() {
            document.getElementById('addModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('addModal').style.display = 'none';
            document.getElementById('addForm').reset();
        }

        // Initialize event listeners
        function initEvents() {
            // Search and filter
            document.getElementById('searchInput').addEventListener('input', filterScripts);
            document.getElementById('categoryFilter').addEventListener('change', filterScripts);
            document.getElementById('resetBtn').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                document.getElementById('categoryFilter').value = 'all';
                filterScripts();
            });

            // Buttons
            document.getElementById('addBtn').addEventListener('click', openModal);
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importBtn').addEventListener('click', () => {
                document.getElementById('importFile').click();
            });
            document.getElementById('importFile').addEventListener('change', (e) => {
                if (e.target.files[0]) importData(e.target.files[0]);
            });
            document.getElementById('clearAllBtn').addEventListener('click', clearAll);

            // Modal
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            document.querySelector('.close-btn').addEventListener('click', closeModal);
            document.getElementById('addModal').addEventListener('click', (e) => {
                if (e.target.id === 'addModal') closeModal();
            });

            // Form
            document.getElementById('addForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const data = {
                    category: document.getElementById('newCategory').value,
                    situation: document.getElementById('newSituation').value,
                    arabic: document.getElementById('newArabic').value,
                    english: document.getElementById('newEnglish').value
                };
                addScript(data);
                closeModal();
            });

            // Auto-save on page close (saves user scripts only)
            window.addEventListener('beforeunload', () => saveUserScripts(userScripts));
        }

        // متغير لتتبع العنصر المسحوب
        let draggedElement = null;

        // وظائف السحب والإفلات
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                const draggedIndex = parseInt(draggedElement.dataset.index);
                const targetIndex = parseInt(this.dataset.index);
                
                // Move item in filtered array
                const draggedItem = filteredScripts[draggedIndex];
                // If either draggedItem or target is a default script, we won't change default order globally.
                // We'll only reorder within the current user's combined view by rearranging userScripts accordingly.
                
                // Compute a new ordering for userScripts after the drop.
                // Strategy: build a new combined array by moving the draggedItem to targetIndex in filteredScripts,
                // then extract the userScripts items in that order and save them.
                
                const newFiltered = [...filteredScripts];
                newFiltered.splice(draggedIndex, 1);
                newFiltered.splice(targetIndex, 0, draggedItem);

                // Extract user script items in the new order
                const newUserOrder = newFiltered.filter(item => !defaultIds.has(item.id));

                // Update userScripts and combined scripts
                userScripts = newUserOrder;
                scripts = [...defaultScripts, ...userScripts];

                saveUserScripts(userScripts);
                renderTable();
                showNotification('تم إعادة الترتيب');
            }

            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            // إزالة فئة drag-over من جميع العناصر
            const rows = document.querySelectorAll('.draggable-row');
            rows.forEach(row => row.classList.remove('drag-over'));
            
            draggedElement = null;
        }

        // Start app
        function init() {
            initEvents();
            filterScripts();
            setTimeout(() => {
                showNotification('مرحباً! اضغط على أي نص لنسخه');
            }, 1000);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
